<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Console</title>
  
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- Libraries -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  
  <!-- Fonts & Icons -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

  <style>
    /* === å…¨å±€æ¨£å¼ === */
    body { background-color: #0a0a0a; color: #f8fafc; font-family: 'Inter', sans-serif; overflow-x: hidden; cursor: none; }
    .swal2-container { z-index: 100000 !important; }
    ::-webkit-scrollbar { width: 8px; }
    ::-webkit-scrollbar-track { background: #0a0a0a; }
    ::-webkit-scrollbar-thumb { background: #334155; border-radius: 4px; }

    /* æ¥µå…‰èƒŒæ™¯ */
    .gradient-bg { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; overflow: hidden; pointer-events: none; }
    .orb { position: absolute; border-radius: 50%; filter: blur(80px); opacity: 0.4; animation: blob 10s infinite cubic-bezier(0.4, 0, 0.2, 1); }
    .orb-1 { top: -10%; left: -10%; width: 50vw; height: 50vw; background: #4f46e5; animation-delay: 0s; }
    .orb-2 { top: 20%; right: -10%; width: 40vw; height: 40vw; background: #10b981; animation-delay: 2s; }
    .orb-3 { bottom: -10%; left: 20%; width: 60vw; height: 60vw; background: #3b82f6; animation-delay: 4s; }
    @keyframes blob { 0% { transform: translate(0, 0) scale(1); } 33% { transform: translate(30px, -50px) scale(1.1); } 66% { transform: translate(-20px, 20px) scale(0.9); } 100% { transform: translate(0, 0) scale(1); } }

    /* ç»ç’ƒè³ªæ„Ÿ */
    .glass-panel { background: rgba(255, 255, 255, 0.03); backdrop-filter: blur(16px); border: 1px solid rgba(255, 255, 255, 0.05); box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1); transition: all 0.3s ease; }
    .glass-input { background: rgba(0, 0, 0, 0.2); border: 1px solid rgba(255, 255, 255, 0.1); color: white; transition: all 0.3s; }
    .glass-input:focus { border-color: #10b981; background: rgba(0, 0, 0, 0.4); outline: none; box-shadow: 0 0 0 2px rgba(16, 185, 129, 0.2); }
    .btn-primary { background: linear-gradient(135deg, #10b981 0%, #059669 100%); box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3); transition: all 0.3s; }
    .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(16, 185, 129, 0.4); }
    
    /* Tabs & List */
    .tab-btn { color: #94a3b8; transition: all 0.3s; border-bottom: 2px solid transparent; }
    .tab-btn:hover { color: white; background: rgba(255,255,255,0.02); }
    .tab-btn.active { color: #10b981; border-bottom-color: #10b981; background: rgba(16, 185, 129, 0.05); }
    
    /* æ¸¸æ¨™ */
    .cursor-dot { width: 8px; height: 8px; background-color: white; position: fixed; top: 0; left: 0; transform: translate(-50%, -50%); border-radius: 50%; z-index: 9999; pointer-events: none; mix-blend-mode: difference; }
    .cursor-outline { width: 40px; height: 40px; border: 1.5px solid rgba(255, 255, 255, 0.5); position: fixed; top: 0; left: 0; transform: translate(-50%, -50%); border-radius: 50%; z-index: 9998; pointer-events: none; transition: width 0.2s, height 0.2s, background-color 0.2s; mix-blend-mode: difference; }
    body.hovering .cursor-outline { width: 60px; height: 60px; background-color: rgba(255, 255, 255, 0.2); border-color: transparent; }
    body.clicking .cursor-outline { transform: translate(-50%, -50%) scale(0.8); }

    /* èŠå¤©ä»‹é¢æ¨£å¼ */
    .chat-session-item { padding: 12px; border-bottom: 1px solid rgba(255,255,255,0.05); cursor: none; transition: background 0.2s; }
    .chat-session-item:hover, .chat-session-item.active { background: rgba(255,255,255,0.05); }
    .msg-bubble { max-width: 75%; padding: 10px 14px; border-radius: 12px; font-size: 0.9rem; line-height: 1.4; margin-bottom: 8px; word-wrap: break-word; }
    .msg-admin { background: #10b981; color: white; align-self: flex-end; border-bottom-right-radius: 2px; }
    .msg-user { background: rgba(255,255,255,0.1); color: #e2e8f0; align-self: flex-start; border-bottom-left-radius: 2px; }

    #preloader { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #0a0a0a; z-index: 99999; display: flex; justify-content: center; align-items: center; transition: opacity 0.8s; }
    .loader-bar { width: 200px; height: 2px; background: #1e293b; margin-top: 20px; overflow: hidden; position: relative; }
    .loader-progress { position: absolute; top: 0; left: 0; height: 100%; width: 0%; background: #10b981; transition: width 0.3s; box-shadow: 0 0 10px #10b981; }
  </style>
</head>
<body class="min-h-screen flex flex-col">

  <script>
    const API_URL = "https://script.google.com/macros/s/AKfycbw1J5DNcuCTfTGeQXhosPZYOW0MAfXDCNBHIi7rQTQMw7Nrfieuc4XEw0diuQkQ6XdUPg/exec";
  </script>

  <div id="preloader">
    <div class="loader-content text-center">
      <div class="text-3xl font-bold text-white tracking-widest mb-2 font-mono">ADMIN CONSOLE</div>
      <div class="text-xs text-slate-500 font-mono mb-4" id="loader-text">WAITING FOR LOGIN...</div>
      <div class="loader-bar"><div class="loader-progress" id="loader-progress"></div></div>
    </div>
  </div>

  <div class="gradient-bg"><div class="orb orb-1"></div><div class="orb orb-2"></div><div class="orb orb-3"></div></div>
  <div class="cursor-dot hidden md:block"></div><div class="cursor-outline hidden md:block"></div>

  <main class="flex-1 p-4 md:p-8 max-w-7xl mx-auto w-full relative z-10">
    
    <!-- Header -->
    <div class="glass-panel rounded-2xl p-1 mb-6 cursor-hover">
      <div class="px-6 py-4 flex flex-col md:flex-row justify-between items-center gap-4 border-b border-white/5">
        <div class="flex items-center gap-4">
          <div class="w-10 h-10 rounded-xl bg-emerald-500/20 flex items-center justify-center text-emerald-400 shadow-lg shadow-emerald-500/10"><i class="fas fa-terminal text-lg"></i></div>
          <div>
            <h1 class="text-lg font-bold tracking-wide text-white">SYSTEM CORE</h1>
            <div class="flex items-center gap-2 text-xs text-slate-400"><span id="status-dot" class="w-2 h-2 rounded-full bg-red-500"></span><span id="status-text">Disconnected</span> <span class="mx-1">|</span> <span id="version-tag" class="font-mono opacity-50">v...</span></div>
          </div>
        </div>
        <div class="flex gap-3">
          <a href="index.html" target="_blank" class="px-4 py-2 rounded-lg text-sm font-medium text-slate-300 hover:text-white hover:bg-white/5 transition flex items-center gap-2 cursor-hover"><i class="fas fa-external-link-alt"></i> é è¦½å‰å°</a>
          <button onclick="logout()" class="px-4 py-2 rounded-lg text-sm font-medium text-red-400 hover:bg-red-500/10 transition border border-red-500/20 cursor-hover"><i class="fas fa-power-off mr-1"></i> ç™»å‡º</button>
        </div>
      </div>
      <div class="flex text-sm font-medium">
        <button onclick="switchTab('dashboard')" id="tab-dashboard" class="tab-btn active flex-1 py-4 flex justify-center items-center gap-2 cursor-hover"><i class="fas fa-chart-pie"></i> å„€è¡¨æ¿</button>
        <button onclick="switchTab('chat')" id="tab-chat" class="tab-btn flex-1 py-4 flex justify-center items-center gap-2 cursor-hover"><i class="fas fa-comments"></i> è¨Šæ¯ä¸­å¿ƒ</button>
        <button onclick="switchTab('cards')" id="tab-cards" class="tab-btn flex-1 py-4 flex justify-center items-center gap-2 cursor-hover"><i class="fas fa-layer-group"></i> å¡ç‰‡ç®¡ç†</button>
        <button onclick="switchTab('settings')" id="tab-settings" class="tab-btn flex-1 py-4 flex justify-center items-center gap-2 cursor-hover"><i class="fas fa-sliders-h"></i> ç³»çµ±è¨­å®š</button>
      </div>
    </div>

    <!-- 1. Dashboard -->
    <div id="view-dashboard" class="space-y-6 animate-fade-in">
      <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
        <div class="glass-panel p-6 rounded-2xl relative overflow-hidden group cursor-hover">
          <div class="absolute top-0 right-0 p-6 opacity-10 transition group-hover:scale-110"><i class="fas fa-link text-5xl text-emerald-400"></i></div>
          <h3 class="text-slate-400 text-xs font-bold uppercase tracking-wider mb-2">Total Links</h3>
          <div class="text-4xl font-bold text-white" id="dash-total-links">-</div>
        </div>
        <!-- ... other stats ... -->
        <div class="glass-panel p-6 rounded-2xl relative overflow-hidden group cursor-hover">
          <div class="absolute top-0 right-0 p-6 opacity-10 transition group-hover:scale-110"><i class="fas fa-comments text-5xl text-indigo-400"></i></div>
          <h3 class="text-slate-400 text-xs font-bold uppercase tracking-wider mb-2">Messages</h3>
          <div class="text-4xl font-bold text-white" id="dash-msg-count">0</div>
        </div>
      </div>
    </div>

    <!-- â˜…â˜…â˜… 2. Chat Center â˜…â˜…â˜… -->
    <div id="view-chat" class="hidden h-[600px] flex gap-6 animate-fade-in">
      <!-- Session List -->
      <div class="w-1/3 glass-panel rounded-2xl overflow-hidden flex flex-col">
        <div class="p-4 border-b border-white/10 bg-white/5">
          <h3 class="font-bold text-white">å°è©±åˆ—è¡¨</h3>
        </div>
        <div id="chat-sessions" class="flex-1 overflow-y-auto">
          <div class="text-center text-slate-500 mt-10">è¼‰å…¥ä¸­...</div>
        </div>
        <button onclick="loadChatSessions()" class="p-3 text-center text-sm text-emerald-400 hover:bg-emerald-500/10 border-t border-white/10 cursor-hover"><i class="fas fa-sync-alt"></i> é‡æ–°æ•´ç†</button>
      </div>
      
      <!-- Chat Window -->
      <div class="flex-1 glass-panel rounded-2xl flex flex-col overflow-hidden relative">
        <div class="p-4 border-b border-white/10 bg-white/5 flex justify-between items-center">
          <div>
             <h3 class="font-bold text-white" id="current-chat-id">è«‹é¸æ“‡å°è©±</h3>
             <div class="text-xs text-slate-500" id="current-chat-time"></div>
          </div>
        </div>
        <div id="chat-history" class="flex-1 overflow-y-auto p-6 flex flex-col gap-2 bg-black/20">
           <!-- Messages go here -->
           <div class="text-center text-slate-600 mt-20">ğŸ‘ˆ å¾å·¦å´é¸æ“‡è¨ªå®¢ä»¥æª¢è¦–è¨Šæ¯</div>
        </div>
        <div class="p-4 border-t border-white/10 bg-white/5 flex gap-2">
          <input type="text" id="reply-input" placeholder="è¼¸å…¥å›è¦†..." class="glass-input flex-1 rounded-lg px-4 py-3" disabled onkeydown="if(event.key==='Enter') sendAdminReply()">
          <button onclick="sendAdminReply()" id="reply-btn" class="btn-primary px-6 rounded-lg text-white font-bold disabled:opacity-50 cursor-hover" disabled>ç™¼é€</button>
        </div>
      </div>
    </div>

    <!-- 3. Card Management -->
    <div id="view-cards" class="hidden space-y-6 animate-fade-in">
      <!-- Edit Form -->
        <div class="glass-panel p-6 rounded-2xl border-l-4 border-l-emerald-500">
          <div class="flex justify-between items-center mb-6">
            <h2 id="form-title" class="text-lg font-bold text-white flex items-center gap-2">
              <i class="fas fa-plus-circle text-emerald-400"></i> æ–°å¢å¡ç‰‡
            </h2>
            <button onclick="resetCardForm()" id="cancel-edit-btn" class="hidden text-xs text-slate-400 hover:text-white px-3 py-1 rounded border border-slate-600 hover:bg-slate-700 cursor-hover">å–æ¶ˆç·¨è¼¯</button>
          </div>
          
          <form id="cardForm" class="space-y-5">
            <input type="hidden" name="id" id="field-id">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
              <div class="space-y-1">
                <label class="text-xs text-slate-400 ml-1">æ¨™é¡Œ</label>
                <input type="text" name="title" id="field-title" required placeholder="Project Title" class="glass-input w-full rounded-lg px-4 py-3">
              </div>
              <div class="space-y-1">
                <label class="text-xs text-slate-400 ml-1">é€£çµ (URL)</label>
                <input type="url" name="url" id="field-url" required placeholder="https://..." class="glass-input w-full rounded-lg px-4 py-3">
              </div>
            </div>
            
            <div class="space-y-1">
              <label class="text-xs text-slate-400 ml-1">åœ–ç‰‡ (Image URL)</label>
              <div class="flex gap-4">
                <input type="url" name="imageUrl" id="field-imageUrl" placeholder="https://..." class="glass-input flex-1 rounded-lg px-4 py-3">
                <div class="w-12 h-12 rounded-lg bg-black/30 border border-white/10 overflow-hidden flex-shrink-0 relative group">
                  <img id="img-preview" src="" onerror="this.style.display='none'" class="w-full h-full object-cover hidden">
                  <div class="absolute inset-0 flex items-center justify-center text-[10px] text-slate-500 bg-black/60 opacity-0 group-hover:opacity-100 transition">é è¦½</div>
                </div>
              </div>
            </div>

            <div class="space-y-1">
              <label class="text-xs text-slate-400 ml-1">æè¿°</label>
              <textarea name="description" id="field-description" rows="2" placeholder="Brief description..." class="glass-input w-full rounded-lg px-4 py-3 resize-none"></textarea>
            </div>

            <button type="submit" id="submit-btn" class="btn-primary w-full py-3 rounded-xl font-bold text-white flex justify-center items-center gap-2 mt-2 cursor-hover">
              <i class="fas fa-save"></i> å„²å­˜å¡ç‰‡
            </button>
          </form>
        </div>
      <div class="glass-panel p-6 rounded-2xl">
        <div class="flex justify-between items-end mb-4 px-1"><h3 class="text-xs font-bold text-slate-400 uppercase tracking-wider">ç›®å‰åˆ—è¡¨</h3><span class="text-[10px] bg-white/5 text-slate-400 px-2 py-1 rounded border border-white/5"><i class="fas fa-arrows-alt mr-1"></i> æ‹–æ›³æ’åº</span></div>
        <div id="card-list" class="space-y-3 pb-4"></div>
      </div>
    </div>

    <!-- 4. Settings (Updated with New Links) -->
    <div id="view-settings" class="hidden space-y-6 animate-fade-in">
      <form id="settingsForm" class="space-y-6">
        <div class="glass-panel p-6 rounded-2xl">
          <h3 class="text-emerald-400 text-sm font-bold mb-6 uppercase border-b border-white/5 pb-2">åŸºæœ¬è³‡æ–™</h3>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
             <div class="space-y-1"><label class="text-xs text-slate-400 ml-1">ç¶²ç«™æ¨™é¡Œ</label><input type="text" name="site_title" class="glass-input w-full rounded-lg px-4 py-3"></div>
             <div class="space-y-1"><label class="text-xs text-slate-400 ml-1">å‰¯æ¨™é¡Œ</label><input type="text" name="site_subtitle" class="glass-input w-full rounded-lg px-4 py-3"></div>
          </div>
          <div class="space-y-1 mb-6"><label class="text-xs text-slate-400 ml-1">é ­åƒ URL</label><input type="url" name="avatar_url" class="glass-input w-full rounded-lg px-4 py-3"></div>
          <div class="space-y-1"><label class="text-xs text-slate-400 ml-1">å€‹äººç°¡ä»‹</label><textarea name="bio_text" class="glass-input w-full rounded-lg px-4 py-3 h-24 resize-none"></textarea></div>
        </div>

        <div class="glass-panel p-6 rounded-2xl">
          <h3 class="text-indigo-400 text-sm font-bold mb-6 uppercase border-b border-white/5 pb-2">ç¤¾ç¾¤é€£çµ</h3>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
             <div class="relative"><i class="fab fa-github absolute left-4 top-3.5 text-slate-500"></i><input type="text" name="github_username" placeholder="GitHub ID" class="glass-input w-full rounded-lg pl-10 pr-4 py-3"></div>
             <div class="relative"><i class="fab fa-instagram absolute left-4 top-3.5 text-slate-500"></i><input type="url" name="instagram_url" placeholder="Instagram URL" class="glass-input w-full rounded-lg pl-10 pr-4 py-3"></div>
             <div class="relative"><i class="fab fa-twitter absolute left-4 top-3.5 text-slate-500"></i><input type="url" name="twitter_url" placeholder="Twitter URL" class="glass-input w-full rounded-lg pl-10 pr-4 py-3"></div>
             <div class="relative"><i class="fab fa-linkedin absolute left-4 top-3.5 text-slate-500"></i><input type="url" name="linkedin_url" placeholder="LinkedIn URL" class="glass-input w-full rounded-lg pl-10 pr-4 py-3"></div>
             <div class="relative"><i class="fab fa-facebook absolute left-4 top-3.5 text-slate-500"></i><input type="url" name="facebook_url" placeholder="Facebook URL" class="glass-input w-full rounded-lg pl-10 pr-4 py-3"></div>
             <div class="relative"><i class="fab fa-youtube absolute left-4 top-3.5 text-slate-500"></i><input type="url" name="youtube_url" placeholder="YouTube Channel URL" class="glass-input w-full rounded-lg pl-10 pr-4 py-3"></div>
             <div class="relative"><i class="fas fa-envelope absolute left-4 top-3.5 text-slate-500"></i><input type="email" name="email_address" placeholder="Email Address" class="glass-input w-full rounded-lg pl-10 pr-4 py-3"></div>
             <div class="relative"><i class="fas fa-globe absolute left-4 top-3.5 text-slate-500"></i><input type="url" name="website_url" placeholder="Personal Website URL" class="glass-input w-full rounded-lg pl-10 pr-4 py-3"></div>
          </div>
        </div>

        <button type="submit" class="btn-primary w-full py-4 rounded-xl font-bold text-white text-lg flex justify-center items-center gap-2 shadow-lg cursor-hover">
          <i class="fas fa-check-circle"></i> å„²å­˜å…¨ç«™è¨­å®š
        </button>
      </form>
    </div>

  </main>

  <script>
    let authToken = '';
    let currentSessionId = null;

    function updateLoader(percent, text) {
      document.getElementById('loader-progress').style.width = percent + '%';
      if(text) document.getElementById('loader-text').innerText = text;
    }

    const Toast = Swal.mixin({
      toast: true, position: 'top-end', showConfirmButton: false, timer: 3000, timerProgressBar: true,
      background: '#1e293b', color: '#fff',
      didOpen: (toast) => { toast.addEventListener('mouseenter', Swal.stopTimer); toast.addEventListener('mouseleave', Swal.resumeTimer); }
    });

    async function callApi(action, payload = {}) {
      if (!authToken) throw new Error("è«‹å…ˆç™»å…¥");
      const response = await fetch(API_URL, {
        method: 'POST',
        body: JSON.stringify({ action: action, password: authToken, payload: payload })
      });
      const result = await response.json();
      if (result.version) document.getElementById('version-tag').innerText = result.version;
      if (result.status === 'error') throw new Error(result.message);
      return result.data;
    }

    window.onload = async () => {
      updateLoader(0, "WAITING FOR LOGIN...");
      initFluidCursor();
      initClickRipple();
      await login();
    };

    async function login() {
      const { value: password } = await Swal.fire({
        title: 'SYSTEM ACCESS', input: 'password', inputPlaceholder: 'Enter Password', confirmButtonText: 'AUTHENTICATE',
        confirmButtonColor: '#10b981', allowOutsideClick: false, background: '#0f172a', color: '#fff',
        backdrop: `rgba(0,0,0,0.8)`, customClass: { input: 'text-center font-mono tracking-widest bg-slate-800 border-slate-600 text-white' }
      });
      if (password) {
        try {
          Swal.showLoading();
          const res = await fetch(`${API_URL}?type=verify&password=${password}`);
          const data = await res.json();
          if (data.status === 'success') {
            authToken = password;
            updateStatus(true);
            if(data.version) document.getElementById('version-tag').innerText = data.version;
            updateLoader(50, "FETCHING DATA...");
            Swal.close();
            initData();
          } else {
            Swal.fire({ icon: 'error', title: 'ACCESS DENIED', text: data.message, background: '#1e293b', color: '#fff' }).then(login);
          }
        } catch(e) {
          Swal.fire({ icon: 'error', title: 'CONNECTION FAILED', text: 'Check GAS deployment.', background: '#1e293b', color: '#fff' });
        }
      }
    }

    function logout() { authToken = ''; location.reload(); }
    function updateStatus(online) {
      const el = document.getElementById('status-dot'), txt = document.getElementById('status-text');
      if(online) { el.className = 'w-2 h-2 rounded-full bg-emerald-400 animate-pulse shadow-[0_0_8px_#10b981]'; txt.innerText = 'Online'; txt.className = 'text-emerald-400 font-bold'; }
    }

    async function initData() {
      try {
        const res = await fetch(`${API_URL}?type=api`);
        const result = await res.json();
        renderCards(result.data);
        renderSettings(result.settings);
        document.getElementById('dash-total-links').innerText = result.data.length;
        updateLoader(100, "READY");
        setTimeout(() => { document.getElementById('preloader').style.opacity = '0'; document.getElementById('preloader').style.visibility = 'hidden'; }, 600);
        loadChatSessions(); // è¼‰å…¥èŠå¤©
      } catch (e) { updateLoader(100, "INIT FAILED"); }
    }

    function switchTab(tab) {
      document.querySelectorAll('[id^="view-"]').forEach(el => el.classList.add('hidden'));
      document.getElementById(`view-${tab}`).classList.remove('hidden');
      document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
      document.getElementById(`tab-${tab}`).classList.add('active');
    }

    // â˜…â˜…â˜… CHAT LOGIC â˜…â˜…â˜…
    async function loadChatSessions() {
      const container = document.getElementById('chat-sessions');
      try {
        const sessions = await callApi('getChatSessions');
        document.getElementById('dash-msg-count').innerText = sessions.length;
        
        if (sessions.length === 0) {
          container.innerHTML = '<div class="text-center text-slate-500 mt-10">æš«ç„¡å°è©±</div>';
          return;
        }
        
        container.innerHTML = sessions.map(s => `
          <div class="chat-session-item ${currentSessionId === s.sessionId ? 'active' : ''}" onclick="openChat('${s.sessionId}')">
            <div class="flex justify-between items-center mb-1">
              <span class="font-bold text-white text-sm truncate w-32">${s.sessionId}</span>
              <span class="text-[10px] text-slate-500">${new Date(s.timestamp).toLocaleDateString()}</span>
            </div>
            <div class="text-xs text-slate-400 truncate">${s.lastMessage}</div>
          </div>
        `).join('');
      } catch (e) { container.innerHTML = '<div class="text-center text-red-400 mt-10">è¼‰å…¥å¤±æ•—</div>'; }
    }

    async function openChat(sid) {
      currentSessionId = sid;
      document.getElementById('current-chat-id').innerText = `Session: ${sid}`;
      document.getElementById('reply-input').disabled = false;
      document.getElementById('reply-btn').disabled = false;
      loadChatHistory(sid);
      // é‡æ–°æ¸²æŸ“åˆ—è¡¨ä»¥é¡¯ç¤º Active ç‹€æ…‹
      loadChatSessions();
    }

    async function loadChatHistory(sid) {
      const container = document.getElementById('chat-history');
      container.innerHTML = '<div class="text-center text-slate-500">è¼‰å…¥ä¸­...</div>';
      try {
        const history = await callApi('getChatHistory', { sessionId: sid });
        container.innerHTML = history.map(m => 
          `<div class="msg-bubble ${m.sender === 'Admin' ? 'msg-admin' : 'msg-user'}">
             ${m.message}
             <div class="text-[9px] opacity-50 mt-1 text-right">${new Date(m.timestamp).toLocaleTimeString()}</div>
           </div>`
        ).join('');
        container.scrollTop = container.scrollHeight;
      } catch(e) {}
    }

    async function sendAdminReply() {
      if(!currentSessionId) return;
      const input = document.getElementById('reply-input');
      const msg = input.value.trim();
      if(!msg) return;
      
      try {
        // æ¨‚è§€æ›´æ–°
        const container = document.getElementById('chat-history');
        container.innerHTML += `<div class="msg-bubble msg-admin">${msg}<div class="text-[9px] opacity-50 mt-1 text-right">Sending...</div></div>`;
        container.scrollTop = container.scrollHeight;
        input.value = '';

        await callApi('adminReply', { sessionId: currentSessionId, message: msg });
        loadChatHistory(currentSessionId); // é‡æ•´
      } catch(e) {
        Toast.fire({icon: 'error', title: 'ç™¼é€å¤±æ•—'});
      }
    }

    // Cards & Settings (ä¿æŒä¸è®Š)
    function renderCards(data) {
      const list = document.getElementById('card-list');
      list.innerHTML = '';
      data.forEach(item => {
        const div = document.createElement('div');
        div.className = 'list-item glass-panel p-4 rounded-xl border border-white/5 flex items-center gap-4 mb-3';
        div.setAttribute('data-id', item.id);
        div.innerHTML = `
          <div class="handle cursor-grab text-slate-500 hover:text-white px-2"><i class="fas fa-grip-vertical"></i></div>
          <div class="w-12 h-12 rounded-lg bg-black/30 border border-white/10 overflow-hidden flex-shrink-0"><img src="${item.imageUrl || ''}" class="w-full h-full object-cover" onerror="this.style.display='none'"></div>
          <div class="flex-1 min-w-0"><div class="font-bold text-white truncate">${item.title}</div><div class="text-xs text-slate-400 truncate">${item.url}</div></div>
          <div class="flex gap-2"><button onclick='editCard(${JSON.stringify(item)})' class="p-2 text-blue-400 hover:bg-blue-500/10 rounded-lg transition cursor-hover"><i class="fas fa-pen"></i></button><button onclick="deleteCard('${item.id}')" class="p-2 text-red-400 hover:bg-red-500/10 rounded-lg transition cursor-hover"><i class="fas fa-trash"></i></button></div>`;
        list.appendChild(div);
      });
      new Sortable(list, { handle: '.handle', animation: 150, ghostClass: 'opacity-50', onEnd: () => { const ids = Array.from(list.children).map(el => el.getAttribute('data-id')); callApi('saveOrder', { ids: ids }).then(() => Toast.fire({ icon: 'success', title: 'æ’åºå·²æ›´æ–°' })); } });
    }

    function editCard(item) {
      document.getElementById('field-id').value = item.id;
      document.getElementById('field-title').value = item.title;
      document.getElementById('field-url').value = item.url;
      document.getElementById('field-imageUrl').value = item.imageUrl;
      document.getElementById('field-description').value = item.description;
      const img = document.getElementById('img-preview'); if(item.imageUrl) { img.src=item.imageUrl; img.classList.remove('hidden'); }
      const btn = document.getElementById('submit-btn'); btn.innerHTML = '<i class="fas fa-sync-alt"></i> æ›´æ–°å¡ç‰‡'; btn.className = "btn-primary w-full py-3 rounded-xl font-bold text-white flex justify-center items-center gap-2 mt-2 bg-blue-600";
      document.getElementById('form-title').innerHTML = '<i class="fas fa-edit text-blue-400"></i> ç·¨è¼¯å¡ç‰‡'; document.getElementById('cancel-edit-btn').classList.remove('hidden'); window.scrollTo({ top: 0, behavior: 'smooth' });
    }
    function deleteCard(id) { Swal.fire({ title: 'ç¢ºå®šåˆªé™¤?', icon: 'warning', showCancelButton: true, confirmButtonText: 'åˆªé™¤', confirmButtonColor: '#ef4444', background: '#1e293b', color:'#fff' }).then((r) => { if(r.isConfirmed) { callApi('deleteData', {id: id}).then(d => { renderCards(d); Toast.fire({ icon: 'success', title: 'å·²åˆªé™¤' }); }); } }); }
    function resetCardForm() { document.getElementById('cardForm').reset(); document.getElementById('field-id').value = ''; document.getElementById('img-preview').classList.add('hidden'); const btn = document.getElementById('submit-btn'); btn.innerHTML = '<i class="fas fa-save"></i> æ–°å¢å¡ç‰‡'; btn.className = "btn-primary w-full py-3 rounded-xl font-bold text-white flex justify-center items-center gap-2 mt-2"; document.getElementById('form-title').innerHTML = '<i class="fas fa-plus-circle text-emerald-400"></i> æ–°å¢å¡ç‰‡'; document.getElementById('cancel-edit-btn').classList.add('hidden'); }
    document.getElementById('cardForm').addEventListener('submit', function(e) { e.preventDefault(); const id = document.getElementById('field-id').value; const payload = { id: id, title: this.title.value, url: this.url.value, imageUrl: this.imageUrl.value, description: this.description.value }; const action = id ? 'updateData' : 'addData'; callApi(action, payload).then((d) => { renderCards(d); resetCardForm(); Toast.fire({ icon: 'success', title: id ? 'æ›´æ–°æˆåŠŸ' : 'æ–°å¢æˆåŠŸ' }); }).catch(err => Toast.fire({ icon: 'error', title: err.message })); });
    function renderSettings(s) { const form = document.getElementById('settingsForm'); for (const key in s) { if (form[key]) form[key].value = s[key]; } }
    document.getElementById('settingsForm').addEventListener('submit', function(e) { e.preventDefault(); const formData = {}; new FormData(this).forEach((v, k) => formData[k] = v); callApi('saveSettings', formData).then((d) => { renderSettings(d); Toast.fire({ icon: 'success', title: 'è¨­å®šå·²å„²å­˜' }); }); });
    document.getElementById('field-imageUrl').addEventListener('input', function() { const img = document.getElementById('img-preview'); if(this.value) { img.src=this.value; img.classList.remove('hidden'); } else img.classList.add('hidden'); });

    function initFluidCursor() {
      const dot = document.querySelector('.cursor-dot'), outline = document.querySelector('.cursor-outline'); let m = {x:0, y:0}, o = {x:0, y:0};
      window.addEventListener('mousemove', e => { m.x=e.clientX; m.y=e.clientY; dot.style.left=`${m.x}px`; dot.style.top=`${m.y}px`; });
      const anim = () => { o.x += (m.x - o.x)*0.15; o.y += (m.y - o.y)*0.15; outline.style.left=`${o.x}px`; outline.style.top=`${o.y}px`; requestAnimationFrame(anim); }; anim();
      new MutationObserver(ms => ms.forEach(m => { if(m.addedNodes.length) attachHover(); })).observe(document.body, {childList:true, subtree:true});
      function attachHover() { document.querySelectorAll('a, button, .cursor-hover, .tab-btn, .chat-session-item').forEach(el => { el.addEventListener('mouseenter', () => document.body.classList.add('hovering')); el.addEventListener('mouseleave', () => document.body.classList.remove('hovering')); }); } attachHover();
    }
    function initClickRipple() { window.addEventListener('click', (e) => { const r = document.createElement('div'); r.className = 'ripple'; r.style.left=`${e.clientX}px`; r.style.top=`${e.clientY}px`; document.body.appendChild(r); setTimeout(()=>r.remove(),600); }); }
  </script>
</body>
</html>
